name: Full CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  IMAGE_TAG: latest
  ECR_REPOSITORY: hafiz-repo
  AWS_REGION: ap-south-1

permissions:
  contents: read
  actions: read

jobs:
  
  #  BUILD REACT APP + DOCKER IMAGE
 
  build:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.image.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build React App
        run: npm run build

      - name: Build Docker Image
        id: image
        run: |
          docker build -t $ECR_REPOSITORY:$IMAGE_TAG .
          echo "image=$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: dist


  #  SECURITY SCANS 
  
  snyk:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v4
      - name: Prepare reports folder
        run: mkdir -p reports
      - name: Install Snyk
        run: npm install -g snyk
      - name: Run Snyk Scan
        run: snyk test --all-projects --json > reports/snyk.json
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  gitleaks:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v4
      - name: Prepare reports folder
        run: mkdir -p reports
      - name: Install Gitleaks
        run: |
          GITLEAKS_VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | grep tag_name | cut -d '"' -f 4)
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION#v}_linux_x64.tar.gz -o gitleaks.tar.gz
          tar -xvzf gitleaks.tar.gz
          sudo mv gitleaks /usr/local/bin/
      - name: Run Gitleaks
        run: gitleaks detect --source . --report-format json --report-path reports/gitleaks.json || true

  trivy-fs:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v4
      - name: Prepare reports folder
        run: mkdir -p reports
      - name: Trivy FS Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: .
          format: json
          output: reports/trivy-fs.json

  trivy-image:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v4
      - name: Prepare reports folder
        run: mkdir -p reports
      - name: Build Docker Image
        run: docker build -t vite-react-app:latest .
      - name: Trivy Image Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: vite-react-app:latest
          format: json
          output: reports/trivy-image.json

  syft-sbom:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v4
      - name: Prepare reports folder
        run: mkdir -p reports
      - name: Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
          syft . -o spdx-json=reports/sbom.json

  
  #  GENERATE HTML REPORTS
  
  generate-html:
    runs-on: ubuntu-latest
    needs: [snyk, gitleaks, trivy-fs, trivy-image, syft-sbom]
    steps:
      - uses: actions/checkout@v4

      - name: Ensure all JSON reports exist
        run: mkdir -p reports && touch reports/{snyk.json,gitleaks.json,trivy-fs.json,trivy-image.json,sbom.json}

      - name: Convert Reports to HTML
        run: |
          mkdir -p reports/html
          for f in reports/*.json; do
            base=$(basename "$f" .json)
            echo "<h2>$base Report</h2><pre>" > reports/html/$base.html
            cat "$f" | jq '.' >> reports/html/$base.html
            echo "</pre>" >> reports/html/$base.html
          done

      - name: Upload Consolidated HTML Reports
        uses: actions/upload-artifact@v4
        with:
          name: html-security-reports
          path: reports/html/

 
  # 4 PUSH TO AWS ECR

  push-to-ecr:
    runs-on: ubuntu-latest
    needs: [generate-html]
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@1d5b9871a7d85a8b3fbaaa99ac9a324bc046bbd4

        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@b6b297b4f85996b7ff8a5e9dbf4a3e204b8b37ad

      - name: Build and Push Docker Image
        run: |
          docker build -t $ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REPOSITORY:$IMAGE_TAG ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/$ECR_REPOSITORY:$IMAGE_TAG
          docker push ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/$ECR_REPOSITORY:$IMAGE_TAG
