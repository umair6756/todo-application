name: Security Scans

on:
  workflow_run:
    workflows: ["Build React App"]
    types:
      - completed

permissions:
  contents: read
  actions: read

jobs:

  snyk:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Prepare reports folder
        run: mkdir -p reports
      - name: Install Snyk
        run: npm install -g snyk
      - name: Run Snyk Scan
        run: snyk test --all-projects --json > reports/snyk.json
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  gitleaks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Prepare reports folder
        run: mkdir -p reports
      - name: Install Gitleaks
        run: |
          GITLEAKS_VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | grep tag_name | cut -d '"' -f 4)
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION#v}_linux_x64.tar.gz -o gitleaks.tar.gz
          tar -xvzf gitleaks.tar.gz
          sudo mv gitleaks /usr/local/bin/
      - name: Run Gitleaks
        run: gitleaks detect --source . --report-format json --report-path reports/gitleaks.json || true

  trivy-fs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Prepare reports folder
        run: mkdir -p reports
      - name: Trivy FS Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: .
          format: json
          output: reports/trivy-fs.json

  trivy-image:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Prepare reports folder
        run: mkdir -p reports
      - name: Build Docker Image
        run: docker build -t vite-react-app:latest .
      - name: Trivy Image Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: vite-react-app:latest
          format: json
          output: reports/trivy-image.json

  syft-sbom:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Prepare reports folder
        run: mkdir -p reports
      - name: Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
          syft . -o spdx-json=reports/sbom.json

  generate-html:
    runs-on: ubuntu-latest
    needs: [ snyk, gitleaks, trivy-fs, trivy-image, syft-sbom]
    steps:
      - uses: actions/checkout@v4
      - name: Convert Reports to HTML
        run: |
          mkdir -p reports/html
          for f in reports/*.json; do
            base=$(basename "$f" .json)
            echo "<h2>$base</h2><pre>" > reports/html/$base.html
            cat "$f" | jq '.' >> reports/html/$base.html
            echo "</pre>" >> reports/html/$base.html
          done
      - uses: actions/upload-artifact@v4
        with:
          name: html-security-reports
          path: reports/html
