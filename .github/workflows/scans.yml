name: Security Scans

on:
  workflow_run:
    workflows: ["Build React App"]
    types:
      - completed
permissions:
  contents: read
  actions: read

jobs:
  sonar:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: SonarQube Scan
        uses: sonarsource/sonarcloud-github-action@master
        with:
          args: >
            -Dsonar.projectKey=vite-react-app
            -Dsonar.organization=my-org
            -Dsonar.host.url=https://sonarcloud.io
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}

  snyk:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Snyk
        run: npm install -g snyk
      - name: Run Snyk Scan
        run: snyk test --all-projects --json > reports/snyk.json
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  gitleaks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Gitleaks
        run: |
          curl -sSL https://github.com/zricethezav/gitleaks/releases/latest/download/gitleaks_8.20.1_linux_x64.tar.gz | tar xz
          sudo mv gitleaks /usr/local/bin/
      - name: Run Gitleaks
        run: gitleaks detect --source . --report-format json --report-path reports/gitleaks.json || true

  trivy-fs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Trivy FS Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: .
          format: html
          output: reports/trivy-fs.html

  trivy-image:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker Image
        run: docker build -t vite-react-app:latest .
      - name: Trivy Image Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: vite-react-app:latest
          format: html
          output: reports/trivy-image.html

  syft-sbom:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
          syft . -o spdx-json=reports/sbom.json

  generate-html:
    runs-on: ubuntu-latest
    needs: [sonar, snyk, gitleaks, trivy-fs, trivy-image, syft-sbom]
    steps:
      - uses: actions/checkout@v4
      - name: Consolidate Reports into HTML
        run: |
          mkdir -p reports/html
          # Convert JSON reports to HTML
          for f in reports/*.json; do
            base=$(basename "$f" .json)
            echo "<h2>$base Report</h2>" > reports/html/$base.html
            cat $f | jq '.' | sed 's/$/<br>/' >> reports/html/$base.html
          done
          # Copy HTML reports
          cp reports/*.html reports/html/
      - uses: actions/upload-artifact@v4
        with:
          name: html-security-reports
          path: reports/html
